import { ref, watch } from 'vue'

export type Locale = 'en' | 'zh' | 'ja'

const STORAGE_KEY = 'kanban-flow.locale'

const resolveInitialLocale = (): Locale => {
  if (typeof window === 'undefined') return 'en'

  const saved = localStorage.getItem(STORAGE_KEY)
  if (saved === 'en' || saved === 'zh' || saved === 'ja') return saved

  const browser = navigator.language.toLowerCase()
  if (browser.startsWith('zh')) return 'zh'
  if (browser.startsWith('ja')) return 'ja'
  return 'en'
}

const messages: Record<Locale, Record<string, string>> = {
  en: {
    'app.name': 'Kanban Flow',
    'app.tagline': 'Ship tasks with clarity and momentum.',
    'badge.local': 'Local-first',
    'badge.tech': 'Vue 3 + TS',
    'nav.board': 'Board',
    'nav.insights': 'Insights',
    'nav.guide': 'Guide',
    'nav.settings': 'Settings',
    'board.title': 'Kanban board',
    'board.subtitle': 'Track the work that matters. Drag tasks to keep momentum.',
    'board.resetFilters': 'Reset filters',
    'board.newTask': 'New task',
    'board.loading': 'Loading your board...',
    'board.emptyColumn': 'Drop a task here or create a new one.',
    'board.confirmDelete': 'Delete this task?',
    'board.toast.updated': 'Task updated',
    'board.toast.created': 'Task created',
    'board.toast.deleted': 'Task deleted',
    'board.toast.moved': 'Moved to {status}',
    'filters.search': 'Search',
    'filters.searchPlaceholder': 'Title, description, or tag',
    'filters.priority': 'Priority',
    'filters.priorityAll': 'All',
    'filters.priorityLow': 'Low',
    'filters.priorityMedium': 'Medium',
    'filters.priorityHigh': 'High',
    'filters.clear': 'Clear ({count})',
    'filters.tags': 'Tags',
    'filters.noTags': 'No tags yet',
    'task.noTags': 'No tags',
    'task.noDue': 'No due date',
    'task.due': 'Due {date}',
    'action.edit': 'Edit',
    'action.delete': 'Delete',
    'action.close': 'Close',
    'action.cancel': 'Cancel',
    'modal.createTitle': 'Create a task',
    'modal.editTitle': 'Edit task',
    'modal.createSubtitle': 'Capture a task with clear intent.',
    'modal.editSubtitle': 'Update details and keep momentum.',
    'form.title': 'Title',
    'form.titlePlaceholder': 'What needs to be done?',
    'form.description': 'Description',
    'form.descriptionPlaceholder': 'Add context or next steps',
    'form.priority': 'Priority',
    'form.dueDate': 'Due date',
    'form.tags': 'Tags',
    'form.tagsPlaceholder': 'design, api, urgent',
    'form.tagsHint': 'Separate with commas. Up to 6 tags.',
    'form.save': 'Save changes',
    'form.create': 'Create task',
    'status.todo': 'Todo',
    'status.doing': 'Doing',
    'status.done': 'Done',
    'priority.low': 'Low',
    'priority.medium': 'Medium',
    'priority.high': 'High',
    'insights.title': 'Insights',
    'insights.subtitle': 'A quick pulse check on your workload.',
    'insights.total': 'Total tasks',
    'insights.doing': 'In progress',
    'insights.done': 'Completed',
    'insights.priorityMix': 'Priority mix',
    'insights.dueSoon': 'Due soon',
    'insights.dueSoonHint': 'Tasks due in the next 7 days.',
    'insights.noDueSoon': 'No upcoming deadlines.',
    'settings.title': 'Settings',
    'settings.subtitle': 'Manage local data and project preferences.',
    'settings.storageTitle': 'Storage',
    'settings.storageDesc':
      'Tasks are stored locally in your browser for privacy and instant startup.',
    'settings.export': 'Export JSON',
    'settings.import': 'Import JSON',
    'settings.clear': 'Clear board',
    'settings.profileTitle': 'Project profile',
    'settings.profileDesc':
      'This project showcases a scalable Vue 3 architecture with Pinia, composables, and testable domain logic.',
    'settings.profileItem1': 'Feature-based structure for tasks and filters.',
    'settings.profileItem2': 'Local-first persistence with schema validation.',
    'settings.profileItem3': 'Strict typing on all task models.',
    'settings.confirmClear': 'Clear all tasks? This cannot be undone.',
    'settings.toast.export': 'Export ready',
    'settings.toast.invalid': 'Invalid task format',
    'settings.toast.imported': 'Tasks imported',
    'settings.toast.importFailed': 'Unable to import file',
    'settings.toast.cleared': 'Board cleared',
    'settings.languageTitle': 'Language',
    'settings.languageDesc': 'Switch the interface language.',
    'guide.title': 'Usage guide',
    'guide.subtitle': 'A quick walkthrough to get the most out of the board.',
    'guide.quickStart.title': 'Quick start',
    'guide.quickStart.item1': 'Click New task and capture the essential details.',
    'guide.quickStart.item2': 'Use tags and priorities to highlight the work that matters.',
    'guide.drag.title': 'Drag & drop',
    'guide.drag.item1': 'Drag cards between columns to update status.',
    'guide.drag.item2': 'Hover a column to see a highlighted drop zone.',
    'guide.filters.title': 'Search & filters',
    'guide.filters.item1': 'Search matches title, description, and tags.',
    'guide.filters.item2': 'Combine priority and tag filters for focus.',
    'guide.data.title': 'Data management',
    'guide.data.item1': 'Export JSON to back up or share your board.',
    'guide.data.item2': 'Import JSON to restore tasks instantly.',
    'guide.tip': 'Tip: keep descriptions concise and set due dates for visibility.',
    'persist.corrupt': 'Saved data was corrupted. Starting with a clean board.',
    'persist.unreadable': 'Unable to read saved tasks. Your board may reset.'
  },
  zh: {
    'app.name': '看板流程管理網頁',
    'app.tagline': '以清晰節奏推進任務。',
    'badge.local': '本機優先',
    'badge.tech': 'Vue 3 + TS',
    'nav.board': '看板',
    'nav.insights': '洞察',
    'nav.guide': '操作說明',
    'nav.settings': '設定',
    'board.title': '看板',
    'board.subtitle': '追蹤重要工作，透過拖曳維持節奏。',
    'board.resetFilters': '重置篩選',
    'board.newTask': '新增任務',
    'board.loading': '載入看板中...',
    'board.emptyColumn': '拖曳任務到此或新增任務。',
    'board.confirmDelete': '要刪除此任務嗎？',
    'board.toast.updated': '任務已更新',
    'board.toast.created': '任務已新增',
    'board.toast.deleted': '任務已刪除',
    'board.toast.moved': '已移至{status}',
    'filters.search': '搜尋',
    'filters.searchPlaceholder': '標題、描述或標籤',
    'filters.priority': '優先級',
    'filters.priorityAll': '全部',
    'filters.priorityLow': '低',
    'filters.priorityMedium': '中',
    'filters.priorityHigh': '高',
    'filters.clear': '清除（{count}）',
    'filters.tags': '標籤',
    'filters.noTags': '尚無標籤',
    'task.noTags': '無標籤',
    'task.noDue': '無截止日期',
    'task.due': '截止 {date}',
    'action.edit': '編輯',
    'action.delete': '刪除',
    'action.close': '關閉',
    'action.cancel': '取消',
    'modal.createTitle': '新增任務',
    'modal.editTitle': '編輯任務',
    'modal.createSubtitle': '以清楚的目標記錄任務。',
    'modal.editSubtitle': '更新細節並保持節奏。',
    'form.title': '標題',
    'form.titlePlaceholder': '要完成什麼？',
    'form.description': '描述',
    'form.descriptionPlaceholder': '補充背景或下一步',
    'form.priority': '優先級',
    'form.dueDate': '截止日期',
    'form.tags': '標籤',
    'form.tagsPlaceholder': '設計, API, 緊急',
    'form.tagsHint': '以逗號分隔，最多 6 個標籤。',
    'form.save': '儲存變更',
    'form.create': '新增任務',
    'status.todo': '待辦',
    'status.doing': '進行中',
    'status.done': '已完成',
    'priority.low': '低',
    'priority.medium': '中',
    'priority.high': '高',
    'insights.title': '洞察',
    'insights.subtitle': '快速檢視工作負載。',
    'insights.total': '總任務數',
    'insights.doing': '進行中',
    'insights.done': '已完成',
    'insights.priorityMix': '優先級分佈',
    'insights.dueSoon': '即將到期',
    'insights.dueSoonHint': '未來 7 天到期的任務。',
    'insights.noDueSoon': '近期沒有截止日期。',
    'settings.title': '設定',
    'settings.subtitle': '管理本機資料與專案偏好。',
    'settings.storageTitle': '儲存',
    'settings.storageDesc': '任務保存在瀏覽器本機，兼顧隱私與啟動速度。',
    'settings.export': '匯出 JSON',
    'settings.import': '匯入 JSON',
    'settings.clear': '清空看板',
    'settings.profileTitle': '專案概述',
    'settings.profileDesc': '本專案展示以 Pinia、composables 與可測試領域邏輯組成的 Vue 3 架構。',
    'settings.profileItem1': '以功能為單位的資料夾結構。',
    'settings.profileItem2': '本機優先保存並具備資料驗證。',
    'settings.profileItem3': '任務模型具嚴格型別。',
    'settings.confirmClear': '要清空所有任務嗎？此操作無法復原。',
    'settings.toast.export': '匯出完成',
    'settings.toast.invalid': '任務格式無效',
    'settings.toast.imported': '已匯入任務',
    'settings.toast.importFailed': '無法匯入檔案',
    'settings.toast.cleared': '看板已清空',
    'settings.languageTitle': '語言',
    'settings.languageDesc': '切換介面語言。',
    'guide.title': '操作說明',
    'guide.subtitle': '快速上手並掌握看板。',
    'guide.quickStart.title': '快速開始',
    'guide.quickStart.item1': '點擊「新增任務」填寫必要資訊。',
    'guide.quickStart.item2': '使用標籤與優先級凸顯重點工作。',
    'guide.drag.title': '拖曳與狀態',
    'guide.drag.item1': '拖曳任務卡到不同欄位即可更新狀態。',
    'guide.drag.item2': '欄位高亮時即可放下任務。',
    'guide.filters.title': '搜尋與篩選',
    'guide.filters.item1': '搜尋會比對標題、描述與標籤。',
    'guide.filters.item2': '可組合優先級與標籤來聚焦。',
    'guide.data.title': '資料管理',
    'guide.data.item1': '匯出 JSON 以備份或分享。',
    'guide.data.item2': '匯入 JSON 可快速復原任務。',
    'guide.tip': '小提示：描述保持精簡，並設定截止日期提升可見度。',
    'persist.corrupt': '已儲存的資料已損毀，已重置看板。',
    'persist.unreadable': '無法讀取已儲存的任務，看板可能會重置。'
  },
  ja: {
    'app.name': 'Kanban Flow',
    'app.tagline': '明快なリズムでタスクを進める。',
    'badge.local': 'ローカル優先',
    'badge.tech': 'Vue 3 + TS',
    'nav.board': 'ボード',
    'nav.insights': 'インサイト',
    'nav.guide': '使い方',
    'nav.settings': '設定',
    'board.title': 'カンバンボード',
    'board.subtitle': '重要な仕事を追跡し、ドラッグで流れを保つ。',
    'board.resetFilters': 'フィルターをリセット',
    'board.newTask': '新規タスク',
    'board.loading': 'ボードを読み込み中...',
    'board.emptyColumn': 'ここにドロップするか新規作成してください。',
    'board.confirmDelete': 'このタスクを削除しますか？',
    'board.toast.updated': 'タスクを更新しました',
    'board.toast.created': 'タスクを作成しました',
    'board.toast.deleted': 'タスクを削除しました',
    'board.toast.moved': '「{status}」へ移動しました',
    'filters.search': '検索',
    'filters.searchPlaceholder': 'タイトル、説明、タグ',
    'filters.priority': '優先度',
    'filters.priorityAll': 'すべて',
    'filters.priorityLow': '低',
    'filters.priorityMedium': '中',
    'filters.priorityHigh': '高',
    'filters.clear': 'クリア（{count}）',
    'filters.tags': 'タグ',
    'filters.noTags': 'タグなし',
    'task.noTags': 'タグなし',
    'task.noDue': '期限なし',
    'task.due': '期限 {date}',
    'action.edit': '編集',
    'action.delete': '削除',
    'action.close': '閉じる',
    'action.cancel': 'キャンセル',
    'modal.createTitle': 'タスクを作成',
    'modal.editTitle': 'タスクを編集',
    'modal.createSubtitle': '目的を明確にしてタスクを記録。',
    'modal.editSubtitle': '詳細を更新して流れを維持。',
    'form.title': 'タイトル',
    'form.titlePlaceholder': '何をやる？',
    'form.description': '説明',
    'form.descriptionPlaceholder': '背景や次のステップを追加',
    'form.priority': '優先度',
    'form.dueDate': '期限日',
    'form.tags': 'タグ',
    'form.tagsPlaceholder': 'design, api, urgent',
    'form.tagsHint': 'カンマ区切り、最大 6 タグ。',
    'form.save': '変更を保存',
    'form.create': 'タスクを作成',
    'status.todo': '未着手',
    'status.doing': '進行中',
    'status.done': '完了',
    'priority.low': '低',
    'priority.medium': '中',
    'priority.high': '高',
    'insights.title': 'インサイト',
    'insights.subtitle': '作業負荷を素早く確認。',
    'insights.total': '総タスク数',
    'insights.doing': '進行中',
    'insights.done': '完了',
    'insights.priorityMix': '優先度の内訳',
    'insights.dueSoon': '期限間近',
    'insights.dueSoonHint': '今後 7 日以内のタスク。',
    'insights.noDueSoon': '直近の期限はありません。',
    'settings.title': '設定',
    'settings.subtitle': 'ローカルデータと設定を管理。',
    'settings.storageTitle': 'ストレージ',
    'settings.storageDesc': 'タスクはブラウザに保存され、プライバシーと起動速度を確保。',
    'settings.export': 'JSON エクスポート',
    'settings.import': 'JSON インポート',
    'settings.clear': 'ボードをクリア',
    'settings.profileTitle': 'プロジェクト概要',
    'settings.profileDesc':
      'Pinia や composables、テスト可能なドメインロジックを備えた Vue 3 構成を紹介。',
    'settings.profileItem1': '機能単位のフォルダ構成。',
    'settings.profileItem2': 'ローカル優先の永続化とスキーマ検証。',
    'settings.profileItem3': 'タスクモデルを厳格に型付け。',
    'settings.confirmClear': 'すべてのタスクを削除しますか？元に戻せません。',
    'settings.toast.export': 'エクスポート準備完了',
    'settings.toast.invalid': 'タスク形式が不正です',
    'settings.toast.imported': 'タスクをインポートしました',
    'settings.toast.importFailed': 'ファイルをインポートできません',
    'settings.toast.cleared': 'ボードをクリアしました',
    'settings.languageTitle': '言語',
    'settings.languageDesc': '表示言語を切り替えます。',
    'guide.title': '使い方',
    'guide.subtitle': 'ボード活用のクイックガイド。',
    'guide.quickStart.title': 'クイックスタート',
    'guide.quickStart.item1': '「新規タスク」から必要情報を入力。',
    'guide.quickStart.item2': 'タグと優先度で重要度を可視化。',
    'guide.drag.title': 'ドラッグ & ドロップ',
    'guide.drag.item1': 'カードを列間でドラッグして状態を更新。',
    'guide.drag.item2': '列がハイライトされたらドロップ可能。',
    'guide.filters.title': '検索とフィルター',
    'guide.filters.item1': '検索はタイトル・説明・タグを対象。',
    'guide.filters.item2': '優先度とタグで絞り込み可能。',
    'guide.data.title': 'データ管理',
    'guide.data.item1': 'JSON をエクスポートしてバックアップ。',
    'guide.data.item2': 'JSON をインポートして即復元。',
    'guide.tip': 'ヒント：説明は簡潔にし、期限日を設定して可視化。',
    'persist.corrupt': '保存データが破損していたためリセットしました。',
    'persist.unreadable':
      '保存済みタスクを読み取れませんでした。ボードがリセットされる可能性があります。'
  }
}

const availableLocales = [
  { value: 'zh', label: '中文' },
  { value: 'en', label: 'English' },
  { value: 'ja', label: '日本語' }
] as const

const locale = ref<Locale>(resolveInitialLocale())

const interpolate = (template: string, params?: Record<string, string | number>) => {
  if (!params) return template
  return template.replace(/\{(\w+)\}/g, (_, key) => `${params[key] ?? ''}`)
}

const t = (key: string, params?: Record<string, string | number>) => {
  const template = messages[locale.value][key] ?? messages.en[key] ?? key
  return interpolate(template, params)
}

let initialized = false

const applyLocale = (value: Locale) => {
  if (typeof document === 'undefined') return

  const lang = value === 'zh' ? 'zh-Hant' : value === 'ja' ? 'ja' : 'en'
  document.documentElement.lang = lang
}

export const useI18n = () => {
  if (!initialized) {
    initialized = true
    watch(
      locale,
      (value) => {
        if (typeof window !== 'undefined') {
          localStorage.setItem(STORAGE_KEY, value)
        }
        applyLocale(value)
      },
      { immediate: true }
    )
  }

  return {
    locale,
    availableLocales,
    t
  }
}
